<?php
function envmap_menu(){
  $items['data/factory/%'] = array(
    'title' => 'Data',
    'page callback' => 'envmap_data',
    'page arguments' => array(2),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'envmap.data.inc',
    'delivery callback' => 'envmap_delivery_js_callback',
  );
  return $items;
}


function envmap_delivery_js_callback($page_result){
  drupal_add_http_header('Content-Type', 'application/javascript; charset=utf-8');
  print $page_result;
}

function envmap_init() { 
   $arg = arg(); 
   $current_path       = current_path(); 
   $current_path_alias = drupal_lookup_path('alias', $current_path); 
   $module_envmap = drupal_get_path('module', 'envmap');  
 
   if ($arg[0] == 'envmap') {
     drupal_add_css($module_envmap . '/envmap/vendor/leaflet/leaflet.css'); 
     drupal_add_css($module_envmap . '/envmap/vendor/markercluster/MarkerCluster.css');
     drupal_add_css($module_envmap . '/envmap/vendor/markercluster/MarkerCluster.Default.css');
     drupal_add_css('https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css', array('type' => 'external'));
     drupal_add_css($module_envmap . '/envmap/vendor/Leaflet.awesome-markers/dist/leaflet.awesome-markers.css');
     drupal_add_css($module_envmap . '/envmap/screen.css');  
     drupal_add_css($module_envmap . '/envmap/custom.css');
     drupal_add_js($module_envmap . '/envmap/vendor/leaflet/leaflet.js'); 
     drupal_add_js($module_envmap . '/envmap/vendor/markercluster/leaflet.markercluster-src.js'); 
     drupal_add_js($module_envmap . '/envmap/vendor/Leaflet.awesome-markers/dist/leaflet.awesome-markers.min.js');
     drupal_add_js($module_envmap . '/envmap/vendor/leaflet.TileLayer.WMTS/leaflet-tilelayer-wmts.js');
     drupal_add_js('https://maps.googleapis.com/maps/api/js?v=3&libraries=places&sensor=false', array('type' => 'external'));
     drupal_add_js($module_envmap . '/envmap/map.js'); 
     drupal_add_js($module_envmap . '/envmap.js');
   } 
 } 


function envmap_block_info() {
  $blocks = array();

  $blocks['mapform'] = array(
    'info' => t('地圖搜尋'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}

function envmap_block_view($delta = '') {
  $block = array();
 
  switch ($delta) {
    case 'mapform':
      $block['subject'] = t('地圖搜尋');
      $block['content'] = drupal_get_form('envmap_form'); 
     break;
  }
  return $block;
}

function envmap_form($form_state){
   $form['factory_address'] = array(
     '#type' => 'textfield',
     //'#title' => '單位地址',
     '#attributes' => array(
      'placeholder' => '請輸入大概的地址或縣市（如台中市OO區）',
     ),
   );
   
   $form['factory_name'] = array(
     '#type' => 'textfield',
     //'#title' => '單位名稱',
     '#attributes' => array(
      'placeholder' => '請輸入部份或企業全名（ 如中國石油）',
     ),
   );

   $form['factory_distbution'] = array(
     '#type' => 'checkbox',
     '#title' => '污染事業單位分布',
   );

   $form['factory'] = array(
     '#type' => 'fieldset',
     '#collapsible' => FALSE,
   );
   $form['factory']['factory_type'] = array(
     '#type' => 'select',
     '#title' => '工廠類型',
     '#options' => array(
     ),
     '#states' => array(
       // Hide the settings when the cancel notify checkbox is disabled.
       'invisible' => array(
         ':input[name="factory_distbution"]' => array('checked' => FALSE),
       ),
     ),
   ); 

   $form['factory']['factory_poltype'] = array(
     '#type' => 'select',
     '#title' => '排放類型',
     '#options' => array(
     //  'is_air' => t('空氣汙染'),
     //  'is_water' => t('水汙染'),
     ),
     '#states' => array(
       // Hide the settings when the cancel notify checkbox is disabled.
       'invisible' => array(
         ':input[name="factory_distbution"]' => array('checked' => FALSE),
       ),
     ),
   );

   $form['factory']['factory_fine'] = array(
     '#type' => 'checkbox',
     '#title' => '有裁罰紀錄',
     '#states' => array(
       'invisible' => array(
         ':input[name="factory_distbution"]' => array('checked' => FALSE),
       ),
     ),
   );
   $form['factory']['factory_realtime'] = array(
     '#type' => 'checkbox',
     '#title' => '即時監測站',
     '#states' => array(
       'invisible' => array(
         ':input[name="factory_distbution"]' => array('checked' => FALSE),
       ),
     ),
   ); 
   $form['factory']['realtime'] = array(
     '#type' => 'fieldset',
     '#collapsible' => FALSE,
   );
   $form['factory']['realtime']['factory_overhead'] = array(
     '#type' => 'checkbox',
     '#title' => '最近一個月超標？',
     '#states' => array(   
      // Hide the settings when the cancel notify checkbox is disabled.
      'invisible' => array( 
        ':input[name="factory_realtime"]' => array('checked' => FALSE),
      ),
     ),  
   );
   
   $form['qualitystation'] = array(
     '#type' => 'checkbox',
     '#title' => '環境品質測站',
   );

   $form['submit'] = array(
     '#prefix' => '<div class="submit-button">',
     '#type' => 'submit', 
     '#value' => '更新地圖',
     '#suffix' => '</div>',
   );

   return $form;
}


function envmap_query_alter(&$query){
  if(isset($query->alterMetaData['view'])) {
    $view =& $query->alterMetaData['view'];
    if($view->name == 'factory_json' && $view->current_display == 'page') {
      // add group by
      $query->groupBy("factory_registration_no");

      // change fields to sum and count
      $fields =& $query->getFields();
      if(!empty($fields['factory_fine_penalty_money'])){
        $f = $fields['factory_fine_penalty_money'];
        $query->addExpression("SUM({$f['table']}.{$f['field']})", $f['alias'].'_');
        $view->field['penalty_money_1']->field_alias = 'factory_fine_penalty_money_';
      }
      if(!empty($fields['factory_fine_id'])){
        $f = $fields['factory_fine_id'];
        $query->addExpression("COUNT({$f['table']}.{$f['field']})", $f['alias']);
      }
    }
  }
}
